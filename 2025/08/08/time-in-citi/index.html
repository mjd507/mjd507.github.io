<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Agency and Trust | Jiandong</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-566LR096XR" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-566LR096XR');
</script><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Agency and Trust</h1><a id="logo" href="/.">Jiandong</a><p class="description">Stop stopping</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Agency and Trust</h1><div class="post-meta">2025-08-08<span> | </span><span class="category"><a href="/categories/Big-Back-End/">Big-Back-End</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%BA%E5%88%B8%E5%8F%91%E8%A1%8C-Issuance"><span class="toc-number">2.</span> <span class="toc-text">债券发行(Issuance)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-tables"><span class="toc-number">2.1.</span> <span class="toc-text">main tables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-mapper"><span class="toc-number">2.2.</span> <span class="toc-text">file-mapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#skeleton-instrument"><span class="toc-number">2.3.</span> <span class="toc-text">skeleton-instrument</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%A2%83%E6%94%AF%E4%BB%98"><span class="toc-number">3.</span> <span class="toc-text">跨境支付</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%A6%E6%88%B7%E8%A1%8C-Account-Bank"><span class="toc-number">3.1.</span> <span class="toc-text">账户行(Account Bank)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PPA-Principe-Paying-Agent"><span class="toc-number">3.2.</span> <span class="toc-text">PPA(Principe Paying Agent)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPA"><span class="toc-number">3.3.</span> <span class="toc-text">IPA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payment-workflow"><span class="toc-number">3.4.</span> <span class="toc-text">payment-workflow</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E9%87%91%E6%89%98%E7%AE%A1-Custody"><span class="toc-number">4.</span> <span class="toc-text">资金托管(Custody)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">基础服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#swift-message"><span class="toc-number">5.1.</span> <span class="toc-text">swift-message</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maintenance"><span class="toc-number">5.2.</span> <span class="toc-text">maintenance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mail-service"><span class="toc-number">5.3.</span> <span class="toc-text">mail-service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rate-fixing"><span class="toc-number">5.4.</span> <span class="toc-text">rate-fixing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ETL"><span class="toc-number">5.5.</span> <span class="toc-text">ETL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E7%AE%A1%E5%90%88%E8%A7%84"><span class="toc-number">6.</span> <span class="toc-text">监管合规</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E8%A3%81%E5%AE%A1%E6%9F%A5-Sanction-Screening"><span class="toc-number">6.1.</span> <span class="toc-text">制裁审查(Sanction Screening)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ISO-message"><span class="toc-number">6.2.</span> <span class="toc-text">ISO message</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">7.</span> <span class="toc-text">其他</span></a></li></ol></div></div><div class="post-content"><p>总结一下项目：代理和信托。</p>
<p>代理涵盖帮助投资机构&#x2F;投资者买卖证券，收益归投资者。</p>
<p>信托涵盖财富管理，收益归约定的受益人。</p>
<span id="more"></span>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>代理和信托是一个存在很久（20年+）的项目，客户端是安装在 Windows 上一个应用程序，服务端是 c#，2020 年开始，决定迁移到更现代化的 web 系统来取代 Windows 上的程序，新项目使用微服务架构，技术栈 SpringBoot + Angular + Jenkins + Openshift，共用 Oracle 数据库。所有功能都包含 maker-checker 以及 audit-trail 等审计流程。</p>
<p>原始功能非常庞大，有一定的业务壁垒，整个迁移周期也是逐渐拉长，目前已经摊开了 40+ 服务模块（前后端各 20+），规划也排到了 2028 年。</p>
<p>以下列举我接触到的模块，模块开发采用<code>充血模型</code>，按照 ops（运营操作人员） 的需求，一点点往里面添加。</p>
<h2 id="债券发行-Issuance"><a href="#债券发行-Issuance" class="headerlink" title="债券发行(Issuance)"></a>债券发行(Issuance)</h2><p>目前是在一级市场进行发债，ops 在和 发行人，投资人等多方敲定好后，会准备一个 Excel 表格，列出要发行的债券发行号，金额，币种，发行人信息，债券类别等信息。系统根据 Excel 信息创建债券。</p>
<h3 id="main-tables"><a href="#main-tables" class="headerlink" title="main tables"></a>main tables</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c_issuer ( <span class="comment">-- 发行主体信息表</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  issuer_name <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  issuer_type <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  client_id NUMBER, <span class="comment">-- 关联主体实体表 (client_contact)</span></span><br><span class="line">  inst_id NUMBER, <span class="comment">-- 关联债券主表 c_instrument</span></span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c_instrument ( <span class="comment">-- 债券基本信息表</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  isin_code <span class="type">VARCHAR</span>(<span class="number">16</span>), <span class="comment">-- 债券代码</span></span><br><span class="line">  isin_name <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  isin_type <span class="type">VARCHAR</span>(<span class="number">10</span>), <span class="comment">-- 国债、企业债、公司债、短融等</span></span><br><span class="line">  issue_scale <span class="type">DECIMAL</span>, <span class="comment">-- 发行面额规模</span></span><br><span class="line">  interest_type <span class="type">VARCHAR</span>(<span class="number">16</span>), <span class="comment">-- 计息方式（固定利率、浮动利率等）</span></span><br><span class="line">  coupon_rate <span class="type">DECIMAL</span>, <span class="comment">-- 票面利率（年化，%）</span></span><br><span class="line">  issue_start_date <span class="type">DATE</span>,</span><br><span class="line">  issue_end_date <span class="type">DATE</span>,</span><br><span class="line">  maturity_date <span class="type">DATE</span>,</span><br><span class="line">  issue_status <span class="type">VARCHAR</span>(<span class="number">16</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> a_event ( <span class="comment">-- 债券发行方案表，1 instrument - n event</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  inst_id NUMBER, <span class="comment">-- 关联债券主表 c_instrument</span></span><br><span class="line">  currency <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  evt_type <span class="type">VARCHAR</span>(<span class="number">16</span>),</span><br><span class="line">  initial_balance <span class="type">DECIMAL</span>,</span><br><span class="line">  conf_bal <span class="type">DECIMAL</span>,</span><br><span class="line">  unconf_bal <span class="type">DECIMAL</span>,</span><br><span class="line">  value_dt <span class="type">DATE</span>,</span><br><span class="line">  usd_currency <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">16</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>发行完成后，理论上有一个认购流程，但是我涉及到的系统并没有涉及到认购流程，猜测发债采取的非公开发行的方式（私募债），仅面向合格机构投资者，认购门槛高（如单笔数百万起），通过线下协议认购。</p>
<p>线下认购完成后，ops 手动初始化 payment。（need confirm， payment 哪个字段关联的投资者）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> a_payment ( <span class="comment">-- 投资认购支付表， 1 event - n payments</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  evt_id NUMBER,</span><br><span class="line">  pmt_no <span class="type">VARCHAR</span>(<span class="number">16</span>),</span><br><span class="line">  pmt_amount <span class="type">DECIMAL</span>,</span><br><span class="line">  pmt_method <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  pmt_status <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  pmt_currency <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  pmt_date <span class="type">DATE</span>,</span><br><span class="line">  pmd_addl_checker NUMBER, <span class="comment">-- risk control table, multi-checker involved.</span></span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="file-mapper"><a href="#file-mapper" class="headerlink" title="file-mapper"></a>file-mapper</h3><p>原始的债券创建流程，包含了多个步骤，需要 ops 跟着 sop 一步一步关联操作，耗时且有一定操作错误的可能性，在新的系统上，我们设计了一个 file-mapper 模块，将债券创建的流程自动化。</p>
<p>按照 细化的债券总模版（上线前配置一次） -&gt; 自定义债券模板（基于总模板，用户自定义） -&gt; 债券具体文件（用户上传，基于自定义的模板）的流程，实现自动化债券发行。</p>
<p>细化总模板阶段，ops 会整理出债券发行所能收集到的字段，字段属性，字段格式，是否必须，默认值等。比如债券编号，发行时间，发行人，机构信息，发行金额，发行币种，利率 等等。</p>
<p>细化的字段非常多，但是每次发行不一定都需要所有这些字段，所以抽象出 自定义债券模板 这一步骤，这个流程里，ops 选择债券模板后，系统会弹出必要的字段，用户可直接使用必要字段创建一个配置模板，也可以继续添加一些可选字段，最后完成配置模版的创建。配置模版包含了，字段信息，字段在 excel 的 列 的角标信息等。</p>
<p>配置模板的创建是为 ops 最后一步上传文件的服务的，所以配置模板的字段一定要与上传的 Excel 文件匹配。 ops 选择配置，并上传 excel，系统会按照配置的内容解析（比如配置模板的第一个字段对应 excel 的第一列，第二个字段对应第五列等），最终按配置生成一个 json，通过 http 发给 issuance 债券服务来自动创建债券，同时提供结果页显示成功和失败的记录，方便参考和修改。</p>
<p>债券的主要 table 见以上 main tables。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- PREDINE TEMPLATE DATA (STATIC DATA) IN BELOW TWO TABLES.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_TEMPLATE (</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  TYPE <span class="type">VARCHAR</span>(<span class="number">16</span>), <span class="comment">-- ISSUANCE CREATE/UPDATE , RATE-FIXING, CUTODY</span></span><br><span class="line">  NAME <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_TEMPLATE_COLS (</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  TEMPLATE_ID NUMBER,</span><br><span class="line">  NAME <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  TYPE <span class="type">VARCHAR</span>(<span class="number">16</span>),</span><br><span class="line">  INDEX NUMBER,</span><br><span class="line">  DFT_VAL <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  REQUIRED <span class="type">CHAR</span>(<span class="number">1</span>),</span><br><span class="line">  FORMAT <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- USER CREATE DATA IN BELOW TWO TABLES</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_CONFIGURATION_TEMPLATE (</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  CONFIG_NAME_PREFIX <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  TEMPLATE_ID NUMBER,</span><br><span class="line">  HAS_HEADER <span class="type">CHAR</span>(<span class="number">1</span>),</span><br><span class="line">  HEADER_CNT NUMBER,</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_CONFIGURATION (</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  CONFIG_TEMPLATE_ID NUMBER,</span><br><span class="line">  CONFIG_NAME <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  COL_ID NUMBER,</span><br><span class="line">  COL_IDX NUMBER,</span><br><span class="line">  DFT_VAL <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- USER UPLOAD File</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_UPLOAD (</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  FM_CONG_ID NUMBER,</span><br><span class="line">  FM_LOCATION <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  FM_STATUS <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> FM_PARSE_DETAIL ( <span class="comment">-- 记录解析信息，在 issuance 服务逐条解析创建时，try-catch-finally 最后统计入表。</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  FM_UPLOAD_ID NUMBER,</span><br><span class="line">  MSG <span class="type">VARCHAR</span>(<span class="number">2048</span>), <span class="comment">-- e.g 200/200 records successfully created. 198/200 records create, 2/200 failed, reason: xxx</span></span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- END</span></span><br></pre></td></tr></table></figure>

<p>由于 file-mapper 良好的设计，现在不仅支持债券的自动化创建，还支持其他模板业务的自动化流程，如 rate-fixing，custody，clearing-system 等。</p>
<h3 id="skeleton-instrument"><a href="#skeleton-instrument" class="headerlink" title="skeleton-instrument"></a>skeleton-instrument</h3><p>除了通过 file-mapper 创建债券，我们还构建了一个后台定时服务，对还没有发行但创建好的债券，进行数据重新计算（按汇率重新计算金额等），一个金融债券交易的骨架，大致包含如下信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;instrument_id&quot;</span>: <span class="string">&quot;FIN-INSTR-2023-0001&quot;</span>,  <span class="comment">// 金融工具唯一标识符</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CREDIT&quot;</span>,  <span class="comment">// 类型：CREDIT(信用类)/EQUITY(权益类)/DERIVATIVE(衍生类)/PAYMENT(支付类)</span></span><br><span class="line">  <span class="attr">&quot;sub_type&quot;</span>: <span class="string">&quot;LETTER_OF_CREDIT&quot;</span>,  <span class="comment">// 子类型：如信用证、债券、汇票等</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;issuer&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;entity_id&quot;</span>: <span class="string">&quot;BANK-001&quot;</span>,  <span class="comment">// 发行机构ID</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Global Trade Bank&quot;</span>,  <span class="comment">// 发行机构名称</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BANK&quot;</span>,  <span class="comment">// 发行机构类型：银行、企业、政府等</span></span><br><span class="line">    <span class="attr">&quot;country&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;credit_rating&quot;</span>: <span class="string">&quot;AA+&quot;</span>  <span class="comment">// 发行机构信用评级</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;counterparty&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;entity_id&quot;</span>: <span class="string">&quot;CLIENT-12345&quot;</span>,  <span class="comment">// 交易对手ID</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;International Trading Co.&quot;</span>,  <span class="comment">// 交易对手名称</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CORPORATE&quot;</span>,  <span class="comment">// 类型：企业、个人等</span></span><br><span class="line">    <span class="attr">&quot;country&quot;</span>: <span class="string">&quot;DE&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;currency&quot;</span>: <span class="string">&quot;USD&quot;</span>,  <span class="comment">// 货币单位</span></span><br><span class="line">    <span class="attr">&quot;principal_amount&quot;</span>: <span class="number">500000.00</span>,  <span class="comment">// 本金金额</span></span><br><span class="line">    <span class="attr">&quot;issue_date&quot;</span>: <span class="string">&quot;2023-11-15&quot;</span>,  <span class="comment">// 发行日期</span></span><br><span class="line">    <span class="attr">&quot;maturity_date&quot;</span>: <span class="string">&quot;2024-11-15&quot;</span>,  <span class="comment">// 到期日</span></span><br><span class="line">    <span class="attr">&quot;interest_rate&quot;</span>: &#123;  <span class="comment">// 利率条款（如适用）</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;FIXED&quot;</span>,  <span class="comment">// 固定/浮动</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span>: <span class="number">3.5</span>,  <span class="comment">// 利率值</span></span><br><span class="line">      <span class="attr">&quot;basis&quot;</span>: <span class="string">&quot;ANNUAL&quot;</span>  <span class="comment">// 计息基础</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;payment_schedule&quot;</span>: [  <span class="comment">// 支付计划（如适用）</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;due_date&quot;</span>: <span class="string">&quot;2024-05-15&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;amount&quot;</span>: <span class="number">8750.00</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;INTEREST&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;due_date&quot;</span>: <span class="string">&quot;2024-11-15&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;amount&quot;</span>: <span class="number">508750.00</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;PRINCIPAL_AND_INTEREST&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;collateral&quot;</span>: &#123;  <span class="comment">// 抵押品信息（如适用）</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;REAL_ESTATE&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Commercial property in Berlin&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="number">750000.00</span>,</span><br><span class="line">    <span class="attr">&quot;valuation_date&quot;</span>: <span class="string">&quot;2023-11-01&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;governing_terms&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;law_jurisdiction&quot;</span>: <span class="string">&quot;New York, USA&quot;</span>,  <span class="comment">// 适用法律管辖地</span></span><br><span class="line">    <span class="attr">&quot;dispute_resolution&quot;</span>: <span class="string">&quot;ARBITRATION&quot;</span>,  <span class="comment">// 争议解决方式</span></span><br><span class="line">    <span class="attr">&quot;amendment_provisions&quot;</span>: <span class="string">&quot;REQUIRES_ALL_PARTIES&quot;</span>  <span class="comment">// 修改条款</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;ACTIVE&quot;</span>,  <span class="comment">// 状态：DRAFT/ACTIVE/EXPIRED/CANCELLED</span></span><br><span class="line">  <span class="attr">&quot;events&quot;</span>: [  <span class="comment">// 事件记录</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;ISSUED&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2023-11-15T10:30:00Z&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Instrument issued by Global Trade Bank&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="跨境支付"><a href="#跨境支付" class="headerlink" title="跨境支付"></a>跨境支付</h2><h3 id="账户行-Account-Bank"><a href="#账户行-Account-Bank" class="headerlink" title="账户行(Account Bank)"></a>账户行(Account Bank)</h3><p>账户行跟债券没有关系，它是一家银行在另一家银行开立账户，并通过该账户进行跨境支付，清算等金融服务。</p>
<p>新系统对账户行迁移了两块重要内容。</p>
<p>1.对符合要求的账单，自动进去结算(MT103&#x2F;MT202)，（工作日 9 - 6 点，每 15 mins）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">paymentRelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// see payment-workflow</span></span><br><span class="line">  <span class="comment">// here only send a trigger msg to mq</span></span><br><span class="line">  accountBankAutoReleaseTrigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.展示清算通知的记录（receive-queue），即以 MT910 为核心的 record，MT910 是账户行在资金接收环节中，向账户持有人传递到账信息的核心工具，是清算的通知凭证。</p>
<p>可以理解为 103&#x2F;202 的 ack 信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> swift_incoming_message <span class="keyword">where</span> msg_type <span class="operator">=</span> <span class="string">&#x27;910&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- display in ui</span></span><br></pre></td></tr></table></figure>

<h3 id="PPA-Principe-Paying-Agent"><a href="#PPA-Principe-Paying-Agent" class="headerlink" title="PPA(Principe Paying Agent)"></a>PPA(Principe Paying Agent)</h3><p>当投资者购买了我们一级市场发行的债券，由于持有人分布在不同国家 &#x2F; 地区，需要通过 PPA 统一协调付款流程，我们也重新设计了 PPA 服务。</p>
<ul>
<li>支持创建需要支付的 payment</li>
<li>payment 验证过程中，增加多种风控策略（按金额大小&#x2F;级别审核）</li>
<li>引入 mq，在验证通过后，发到 mq，由 payment-workflow 服务统一对外支付</li>
<li>对特定币种，特定阈值下的 payment，支持自动 release。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">paymentRelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// see payment-workflow</span></span><br><span class="line">  <span class="comment">// here only do basic validation, then send a trigger msg to mq</span></span><br><span class="line">  ppaAutoReleaseTrigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>claim-letter 在 ppa 中的作用是？</p>
<h3 id="IPA"><a href="#IPA" class="headerlink" title="IPA"></a>IPA</h3><p>IPA 是发行人与初始购买人（通常为承销商或主承销商）之间签订的协议，核心作用是明确双方在债券初始发行阶段的权利、义务和交易细节。</p>
<p>这里上游的信息在我们新系统没有具体体现，但集成了 IPA 汇款的流程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">paymentRelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// see payment-workflow</span></span><br><span class="line">  <span class="comment">// here only do basic validation, then send a trigger msg to mq</span></span><br><span class="line">  ipaReleaseTrigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="payment-workflow"><a href="#payment-workflow" class="headerlink" title="payment-workflow"></a>payment-workflow</h3><p>核心汇款的流程都在这个服务，包含了 ipa&#x2F;ppa&#x2F;account-bank 三种类型的汇款服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以 ppa 为例</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">paymentRelease</span><span class="params">(PaymentDetail paymentDetail)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    releaseFunding(paymentDetail); <span class="comment">// in a new transaction. if failed won&#x27;t affect payment release.</span></span><br><span class="line">    validatePayment(paymentDetail); <span class="comment">// status, balance, etc</span></span><br><span class="line">    updatePayment(paymentDetail);</span><br><span class="line">    generateAndSendSwiftMessage(paymentDetail);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">    <span class="comment">// collect error msg, display in ui</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(propagation = REQUIRED_NEW)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseFunding</span><span class="params">(PaymentDetail paymentDetail)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> event = retrieveEvent(paymentDetail);</span><br><span class="line">  <span class="comment">// calc conf balance, update event</span></span><br><span class="line">  <span class="keyword">var</span> funding = retrieveOrCreateFunding(event);</span><br><span class="line">  funding.setStatus(<span class="string">&quot;RLSD&quot;</span>);</span><br><span class="line">  funding.setAmount(event.initialBalance);</span><br><span class="line">  event.setConfBalance(paymentDetail.amount);</span><br><span class="line">  updateFunding(funding);</span><br><span class="line">  updateEvent(event);</span><br><span class="line">  generateAndSendSwiftMessage(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">generateAndSendSwiftMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 生成 103 或者 202 的swift，</span></span><br><span class="line">  <span class="comment">// 发往下游进行汇款操作。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="资金托管-Custody"><a href="#资金托管-Custody" class="headerlink" title="资金托管(Custody)"></a>资金托管(Custody)</h2><p>新的服务重新设计了托管账号相关的管理功能，MT537 结算通知相关的功能，以及新开发的托管支付流程。</p>
<p>1.托管账号管理 (safekeeping account)。</p>
<p>方便托管人与搜托人进行沟通，以及交易结算。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">create</span> ct_sfkp ( <span class="comment">-- 托管资产表</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  sfkp_no <span class="type">VARCHAR</span>(<span class="number">32</span>), <span class="comment">-- e.g. SK202508120001</span></span><br><span class="line">  sfkp_acc_id <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  assert_type <span class="type">VARCHAR</span>(<span class="number">4</span>), <span class="comment">-- 资产类型，一般为债券</span></span><br><span class="line">  assert_code <span class="type">VARCHAR</span>(<span class="number">32</span>), <span class="comment">-- 债券的话为 isin_code</span></span><br><span class="line">  currency <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  start_date <span class="type">DATE</span>,</span><br><span class="line">  maturity_date <span class="type">DATE</span>,</span><br><span class="line">  last_valuation_date <span class="type">DATE</span>,</span><br><span class="line">  agreement_id NUMBER, <span class="comment">-- 关联托管协议编号</span></span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> ct_sfkp_acc ( <span class="comment">-- 托管账户</span></span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  sfkp_acc <span class="type">VARCHAR</span>(<span class="number">32</span>), <span class="comment">-- unique</span></span><br><span class="line">  client_id NUMBER, <span class="comment">-- 关联客户实体表 (client_contact)</span></span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  email <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.MT537 (Securities Settlement Transaction Status Advice - 证券结算交易状态通知）。</p>
<p>它主要用于在证券交易的结算环节，向相关参与方（如托管行、经纪商、客户等）通知证券结算交易的处理状态，例如确认交易已完成、提示交易失败及原因，通知部分结算等。</p>
<p>托管行根据每个工作日最新证券结算的相关状态数据，计算出托管账户最新的持仓信息，并通过 MT537 通知给客户。</p>
<p>虽从公司角度，MT537 是由我们托管行发出的，但是作为一个内部系统，我们也是 MT537 的一个接受方，系统会基于 MT537 生成 daily&#x2F;monthly 的 pdf 的详细结算信息，ops 每个月也会将 monthly 投资信息的 pdf 通过 email 发送给 客户。</p>
<p>所以基于 MT537 反向创建 safekeeping account，也是我们系统的一个功能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ct_sfkp_penalty(</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  sfkp_acc <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  transaction_ref <span class="type">VARCHAR</span>(<span class="number">64</span>), <span class="comment">-- 20C</span></span><br><span class="line">  status_code <span class="type">VARCHAR</span>(<span class="number">4</span>), <span class="comment">-- 23G, &#x27;STLD&#x27;= 已结算，&#x27;PEND&#x27;= 待处理，&#x27;RJCT&#x27;= 被拒绝</span></span><br><span class="line">  status_reason <span class="type">VARCHAR</span>(<span class="number">4</span>), <span class="comment">-- 79A &#x27;INSU&#x27;= 资金不足，&#x27;INVA&#x27;= 无效账户</span></span><br><span class="line">  isin_code <span class="type">VARCHAR</span>(<span class="number">32</span>), </span><br><span class="line">  quantity <span class="type">DECIMAL</span>,</span><br><span class="line">  currency <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  settlement_date <span class="type">DATE</span>,</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ct_sfkp_penalty_report(</span><br><span class="line">  ID NUMBER AUTO_INCREMENT,</span><br><span class="line">  sfkp_acc <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  frequency <span class="type">VARCHAR</span>(<span class="number">4</span>), <span class="comment">-- daily/monthly</span></span><br><span class="line">  location <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>3.托管支付流程 custody payment instruction</p>
<p>是一个新功能，为了简化 ops 工作量的功能。 ops 谈的合同大多数基于邮箱邮件，由于邮件繁多，且每一个客户的流程状态无法直观记忆，故开发了此功能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> pmt_instruction(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  mail_id NUMBER,</span><br><span class="line">  subject <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">6</span>),</span><br><span class="line">  receive_date <span class="type">DATE</span>,</span><br><span class="line">  comment <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>在读取到指定邮箱的邮件并入表保存后，展示在 receive queue 页面</li>
<li>ops 基于与用户的沟通，将记录 move 到对应的 authorise queue，signature queue，complete queue 等页面</li>
<li>在 complete queue 之前，ops 可以生成并发送 103&#x2F;202 支付指令，将收益汇给受益人。</li>
</ul>
<h2 id="基础服务"><a href="#基础服务" class="headerlink" title="基础服务"></a>基础服务</h2><h3 id="swift-message"><a href="#swift-message" class="headerlink" title="swift-message"></a>swift-message</h3><p>1.核心服务，负责监听所有入站的 swift message 的入口。使用 jms 监听 incoming queue，解析 message，并根据路由配置转发到其他服务。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> swift_incoming_message(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  module_identifier <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  msg_type <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  module_name <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  sft_msg TEXT,</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> swift_message_routing(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  msg_type <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  module_name <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  receive_url <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JmsListener(destination = &quot;queue-name&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(String rawMessage)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// get delivery times from the broker, if more than 3 times, ignore processing. </span></span><br><span class="line">    <span class="comment">// default delivery times is 10, by more observation, we see almost all re-delivery </span></span><br><span class="line">    <span class="comment">// are due to our own handler logic, so its really not good to re-try with same error for 10 times.</span></span><br><span class="line">    <span class="meta">@Nullable</span> BaseSwiftMessage swiftMsg = parseMessage(rawMessage);</span><br><span class="line">    saveMessage(rawMessage, swiftMsg);</span><br><span class="line">    List&lt;Routing&gt; routerConfs = getRoutingConfig(swiftMsg.msgType);</span><br><span class="line">    callEachModule(routerConfs, swiftMsg);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="comment">// based on particular err to decide ignore or re-throw</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>目前这里的实现方式有一定风险，尤其在消息堆压的情况下，事务里的 http 调用，很影响性能，吞吐会明显下降。</p>
<p>如果能重来，我会选择 outbox pattern，借助一张中间表分离 message 入表和 http call，当监听到 message 进来时，只做 db 的写操作，将状态记到中间表里，确保进来的消息能顺利持久化，同时通过 event 驱动，异步进行 http call 并更新状态。当然 http 有失败的情况，可采取定时扫描中间表并再次通过 event 进行 http call，直到成功为止。</p>
<p>增加吞吐的同时，保证了最终一致性。</p>
<p>2.目前入站的 swift 消息类型包括但不仅限于：</p>
<blockquote>
<p>199：银行间的一般性信息传递，它并非支付指令，也不是银行资金担保或者资金承付的文件，不具备法律约束力的金融承诺性质。<br>210：核心作用是资金接收的预先通知。Notice to Receive<br>299：通常与金融交易（如支付、担保、贸易融资等）的补充说明或业务沟通相关。<br>548：确认证券在托管账户间的转移状态（证券存入 &#x2F; 提取通知）。<br>537：同步证券结算的状态信息（证券结算交易状态通知）<br>568：记录和通知同一机构内部证券持仓的变动（账户内持仓变动通知）<br>599：传递无法通过其他标准化证券报文（如 MT537、MT548 等）覆盖的自定义信息，是证券业务沟通的补充工具。<br>799：银行间就保函、备用信用证等担保类业务进行沟通、确认或补充说明<br>910：通知账户贷记信息的标准化报文<br>999：银行与客户（包括企业、金融机构等）之间，传递与账户管理、资金流动相关的非标准化信息，是现金管理场景中灵活沟通的补充工具</p>
</blockquote>
<p>当我们发起一笔汇款指令（103 或者 202）时，一般会收到 910 的 ack 信息，表示资金已到账，收到 999 的 ack，表示汇款存在问题，如账户信息不正确等。</p>
<h3 id="maintenance"><a href="#maintenance" class="headerlink" title="maintenance"></a>maintenance</h3><p>配置模版，各个业务模版需要的配置信息，都设计在此模块。</p>
<p>1.Threshold Config</p>
<p>PPA&#x2F;Account_Bank&#x2F;Issuance 的每笔账单校验，需要的 user 等级，以及需要几个 user 校验。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> pmt_threshold(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  module_name <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  pmt_amount <span class="type">DECIMAL</span>,</span><br><span class="line">  check1_level NUMBER,</span><br><span class="line">  check2_level NUMBER,</span><br><span class="line">  check3_level NUMBER,</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>2.currency cutoff time </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> pmt_ccy_cutoff(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  module_name <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">  ccy <span class="type">VARCHAR</span>(<span class="number">3</span>),</span><br><span class="line">  start_time <span class="type">VARCHAR</span>(<span class="number">6</span>),</span><br><span class="line">  end_time <span class="type">VARCHAR</span>(<span class="number">6</span>),</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">4</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<h3 id="mail-service"><a href="#mail-service" class="headerlink" title="mail-service"></a>mail-service</h3><p>1.从 ops 指定的邮箱中读取邮件，并存储到数据库中，邮件内容为 payment 的一些信息确认信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> inbound_mail ( <span class="comment">-- 邮箱里的邮件信息</span></span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  mailbox <span class="type">VARCHAR</span>(<span class="number">32</span>), <span class="comment">-- 哪个邮箱</span></span><br><span class="line">  msg_id <span class="type">VARCHAR</span>(<span class="number">255</span>), <span class="comment">-- 每封邮件的唯一 id</span></span><br><span class="line">  subject <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  <span class="keyword">from</span> <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  <span class="keyword">to</span> <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  cc <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  receive_date <span class="type">DATE</span>,</span><br><span class="line">  mail_content <span class="type">CLOB</span> <span class="comment">-- 整个邮件的内容</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> inbound_mail_attachment ( <span class="comment">-- 每封邮件的附件</span></span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  mail_id NUMBER,</span><br><span class="line">  attachment <span class="type">CLOB</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.将读取的邮件，借助路由表通过 http 转发到配置的模板处理。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> mail_routing(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  module_name <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  mailbox <span class="type">VARCHAR</span>(<span class="number">32</span>)</span><br><span class="line">  receive_url <span class="type">VARCHAR</span>(<span class="number">32</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>由于公司的创建的邮箱只支持 pop3 协议，所以只能通过定时拉取的方式（每 5 分钟）获取 inbox 目录所有的邮件。</p>
<p>该方案有两个问题：1. 非实时获取 2. 性能问题，inbox 所有邮件会被多次拉取。且邮件会越来越多。</p>
<p>在运行了两年多后，零碎报出了线程 hang 住的情况，最终跟每个邮箱的 owner 协商，开启了 inbox 目录的自动归档功能，超过一个月的邮件自动 move 到 archive 目录，又平稳运行了 2 年多，不在有新的问题。</p>
<h3 id="rate-fixing"><a href="#rate-fixing" class="headerlink" title="rate-fixing"></a>rate-fixing</h3><h3 id="ETL"><a href="#ETL" class="headerlink" title="ETL"></a>ETL</h3><p>涵盖几十个需要批处理的 job，选择了 spring-batch 作为 etl 开发的基本框架。</p>
<p>1.HR_FEED：每天拉取整个公司员工（40w+）的信息，过滤出 emea &amp; apac 的员工，提取出 id，manager id，region，level 等信息落表。用于支付流程授权时风控校验。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_detail (</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  u_id <span class="type">VARCHAR</span>(<span class="number">7</span>),</span><br><span class="line">  m_id <span class="type">VARCHAR</span>(<span class="number">7</span>),</span><br><span class="line">  level <span class="type">VARCHAR</span>(<span class="number">2</span>),</span><br><span class="line">  region <span class="type">VARCHAR</span>(<span class="number">5</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">ItemReader&lt;User&gt; <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemReader = <span class="keyword">new</span> FlatFileItemReader(filePath);</span><br><span class="line">  LineMapper&lt;User&gt; lineMapper = <span class="keyword">new</span> DefaultLineMapper&lt;&gt;();</span><br><span class="line">  <span class="keyword">var</span> lineTokenizer = <span class="keyword">new</span> DelimitedLineTokenizer();</span><br><span class="line">  lineTokenizer.setDelimiter(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">  lineTokenizer.setNames(Arrays.stream(User.class.getDeclaredFields()).map(Field::getName).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">  defaultLineMapper.setLineTokenizer(lineTokenizer);</span><br><span class="line">  <span class="keyword">var</span> fieldSetMapper = <span class="keyword">new</span> BeanWrapperFieldSetMapper&lt;&gt;();</span><br><span class="line">  fieldSetMapper.setTargetType(User.class);</span><br><span class="line">  defaultLineMapper.setFieldSetMapper(fieldSetMapper);</span><br><span class="line">  <span class="keyword">return</span> itemReader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">ItemProcessor&lt;User, User&gt; <span class="title">processor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ItemProcessor&lt;User, User&gt;() &#123;</span><br><span class="line">    <span class="function">User <span class="title">process</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// filter user.region equal apac or emea</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">ItemWriter&lt;Person&gt; <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> JdbcBatchItemWriter&lt;&gt;() &#123;</span><br><span class="line">    setSql(<span class="string">&quot;insert into user values xxxx &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于读取的文件非常大，每行的字段也非常多，这里采取了两种优化策略，最终将 job 的时间控制在 40s 左右。</p>
<ol>
<li>将大文件切割，在 batch 增加一个前置的 tasklet，使用 linux command <code>split</code> 按 5000 行一个子文件，将大文件切割成 8 - 10 个小文件。通过线程池并发处理这些小文件。</li>
<li>spring batch 中的 LineMapper 支持指定列的提取，这样每一行数十个字段，我们只要给定位置，就能将需要的字段提取出来。</li>
</ol>
<p>2.GENSIS_FEED daily&#x2F;monthly， 核心流程与上面类似，不在叙述。</p>
<p>特别想说，在写单元测试时，mock 那一套，对于 spring batch 或者 spring integration 来说，不适用，我看到了大量的 mock 框架里面实现类的单测，层层 mock，毫无意义。</p>
<p>更多的是需要写集成测试，由于 etl 积累的大量的 job，如果每个 job 都启动一个大的 application content，ci 的时间会很长。所以最终在写集成测试时，指定需要加载进 spring context 的类文件，经此改造，etl 项目的 ci 时间由 15 mins 降低到 6 mins。</p>
<p>当然由于内网本地无法安装 docker，build 容器的内存也有限，否则 test container 是一个更佳的选择。我们实际 数据库是 Oracle，但 ci 阶段只能折中选择 h2，db 层面的差异比如 view 的支持，也导致集成测试需要做一些额外的配置或妥协。</p>
<h2 id="监管合规"><a href="#监管合规" class="headerlink" title="监管合规"></a>监管合规</h2><h3 id="制裁审查-Sanction-Screening"><a href="#制裁审查-Sanction-Screening" class="headerlink" title="制裁审查(Sanction Screening)"></a>制裁审查(Sanction Screening)</h3><p>该功能也是我主导设计，ISO 是 2025 年一个监管要求，国际件银行通信标准需要由 swift 格式转换到 ISO xml 的格式。</p>
<p>incoming message 的 screening 在 swift-message 服务监听到时，就会触发。<br>outgoinh message 在手动创建时触发。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sft_sanc_screening(</span><br><span class="line">  id NUMBER AUTO_INCREMENT,</span><br><span class="line">  msg_type <span class="type">VARCHAR</span>(<span class="number">3</span>),</span><br><span class="line">  msg_identifier <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  re_screening <span class="type">VARCHAR</span>(<span class="number">1</span>),</span><br><span class="line">  direction <span class="type">VARCHAR</span>(<span class="number">1</span>),</span><br><span class="line">  xml_body text,</span><br><span class="line">  request_time <span class="type">DATE</span>,</span><br><span class="line">  response_time <span class="type">DATE</span>,</span><br><span class="line">  status <span class="type">VARCHAR</span>(<span class="number">6</span>),</span><br><span class="line">  CREATED_AT <span class="type">DATE</span>,</span><br><span class="line">  UPDATED_AT <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>设计时按照抽象和组合的原则，划分了新老 message 的接口流程，增加类似 spring 中的 aware 回调，以及较为公共实现的 support 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISanctionScreeningService</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ISanctionScreeningNewFlowService</span>&lt;<span class="title">S</span>&gt;, <span class="title">ISacntionScreeningAware</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">performScreening</span><span class="params">(ScreeningRequest screeningRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      beforeScreening(screeningRequest);</span><br><span class="line">      <span class="keyword">var</span> message = fetchMessage(screeningRequest);</span><br><span class="line">      <span class="keyword">if</span> (isNewMessage(screeningRequest)) &#123;</span><br><span class="line">        <span class="keyword">var</span> canonicalModel = callPartnerATeam(message);</span><br><span class="line">        <span class="keyword">var</span> sancScreenng = persistSancScreening(screeningRequest, <span class="keyword">null</span>);</span><br><span class="line">        callPartnerBTeam(canonicalModel);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> swift = parseMessage(message);</span><br><span class="line">        <span class="keyword">var</span> hdr = generateXmlHeader(swift);</span><br><span class="line">        <span class="keyword">var</span> body = generateXmlBody(swift);</span><br><span class="line">        <span class="keyword">var</span> sancScreenng = persistSancScreening(screeningRequest, hdr + body);</span><br><span class="line">        sendToMqForScreening(sancScreenng);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">      handleException(ex);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      afterScreening(screeningRequest);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@KafkaListener(&quot;new-flow-queue&quot;)</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">kafkaResponse</span><span class="params">(Consumer&lt;Record&gt; record)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> response = record.get();</span><br><span class="line">  <span class="keyword">var</span> sancScreening = parseMessage(response);</span><br><span class="line">  updateSancScreening(sancScreening);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JmsListener(&quot;existing-screening-queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jmsListener</span><span class="params">(response)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> response = record.get();</span><br><span class="line">  <span class="keyword">var</span> sancScreening = parseMessage(response);</span><br><span class="line">  updateSancScreening(sancScreening);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ISO-message"><a href="#ISO-message" class="headerlink" title="ISO message"></a>ISO message</h3><p>ISO 具体的生成服务由另一个团队提供。不在叙述。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>项目采用微服务的架构跑了 5 年多，我们并没有搭建服务注册中心&#x2F;配置中心等必要组件，也没有考虑使用 rpc 代替 https， 而是依赖 openshift (类似 k8s) 这种云服务本身提供的能力，比如 configmap，router，减少了一定的维护成本，同时在弹性扩容方面也更简单化。</p>
<p>这两年困扰团队的问题是 cvm 方面的问题，我们需要时刻紧跟最新的框架版本，比如 spring-boot，如果是一两个服务还好，但我们几十个服务，每次都需要改版本号，回归测试，qa 同事额外花了不少时间。</p>
<p>现在在看，也许聚合一些个模块是个更好的选择，采用 monolith，同时在组织包名时模块化，在成本上会好很多。 spring 也推出了 spring-modulith 来强约束我们的 package 之间的依赖。</p>
<p>在这里，最大的收获就是，公司选取的所有框架都是基于开源社区的，我们鼓励参与开源，鼓励参与到日常使用的开源框架的贡献中，学习框架的代码设计，注重集成测试。让技术和业务都成为自己难以替代的一部分。</p>
<p>End</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>Title: </span>Agency and Trust</p><p><span>Author: </span>Jiandong</p><p><span>Date: </span>2025-08-08</p><p><span>Last Update: </span>2025-08-18</p><p><span>Blog Link: </span><a href="/2025/08/08/time-in-citi/">https://mjd507.github.io/2025/08/08/time-in-citi/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://mjd507.github.io/2025/08/08/time-in-citi/"></i></span></p><p><span>Copyright Declaration: </span>Please refer carefully, most of the content I have not fully mastered.</p></div><br><div class="tags"></div><div class="post-nav"><a class="next" href="/2025/07/27/RestClient/">RestClient</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="https://unpkg.com/blueimp-md5/js/md5.js"></script><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: 'fa8d49cc90698365347d',
  clientSecret: 'ad101f458b7f3950fccc09b931977c106cd2c467',
  repo: 'mjd507.github.io',
  owner: 'mjd507',
  admin: ['mjd507'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Back-End/">Big-Back-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Front-End/">Big-Front-End</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://dashaun.com/posts/" title="DaShaun Carter" target="_blank">DaShaun Carter</a><ul></ul><a href="https://develotters.com/" title="develotters" target="_blank">develotters</a><ul></ul><a href="https://vladmihalcea.com/blog/" title="Vlad Mihalcea" target="_blank">Vlad Mihalcea</a><ul></ul><a href="https://www.danvega.dev/blog/" title="Dan Vega" target="_blank">Dan Vega</a><ul></ul><a href="https://imququ.com/" title="Jerry Qu" target="_blank">Jerry Qu</a><ul></ul><a href="https://www.techtalksweekly.io/" title="Tech Talks Weekly" target="_blank">Tech Talks Weekly</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Jiandong.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>