<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>设计一个 kv 缓存系统 | mjd507</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '1c847d4fb515d19b6108f15a5387f1d6';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">设计一个 kv 缓存系统</h1><a id="logo" href="/.">mjd507</a><p class="description">Stop stopping</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">设计一个 kv 缓存系统</h1><div class="post-meta">2019-12-21<span> | </span><span class="category"><a href="/categories/Back-End/">Back-End</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E5%92%8C%E8%AE%A1%E7%AE%97"><span class="toc-number">1.</span> <span class="toc-text">1. 准备和计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8A%BD%E8%B1%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">2. 抽象设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">3. 核心组件设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%89%A9%E5%B1%95%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">4. 扩展服务设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%BF%9B%E4%B8%80%E6%AD%A5%E8%AE%A8%E8%AE%BA"><span class="toc-number">5.</span> <span class="toc-text">5. 进一步讨论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%85%B6%E4%BB%96"><span class="toc-number">6.</span> <span class="toc-text">6. 其他</span></a></li></ol></div></div><div class="post-content"><p>设计一个 kv 内存缓存系统，保存最近 web 的查询</p>
<span id="more"></span>

<h2 id="1-准备和计算"><a href="#1-准备和计算" class="headerlink" title="1. 准备和计算"></a>1. 准备和计算</h2><p>面试官一般会提供一些假设和约束，比如用户量，数据量等，我们需要粗略做个计算。</p>
<p>假设这题有以下假设和约束：</p>
<ul>
<li>用户数 1000w </li>
<li>每月查询量 100 亿</li>
<li>内存有限</li>
<li>要求低延时</li>
<li>服务高可用</li>
</ul>
<p>我们可以做出如下粗略盘点：</p>
<ul>
<li><p>假设每个查询 50 个 bytes，根据查询解析出的 key 算它 20 bytes，value 是一个快照 snippet 算它 200 bytes，那么一次查询共 270 bytes.</p>
</li>
<li><p>每条查询 270 byte ，每月 100 亿查询，如果每次查询都是唯一的话，需要存储 <strong>2.7T</strong> 数据。</p>
</li>
<li><p>每月 100 亿查询，每月 250万 秒，平均每秒 4000 次</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1G ≈ 1000M ≈ 1000000K(100万k) ≈ 1000000000b(10亿byte)</span><br><span class="line"></span><br><span class="line">1T ≈ 10000亿byte</span><br><span class="line"></span><br><span class="line">30 天 = 24 * 30 h = 24 * 30 * 3600 s ≈ 250万 s</span><br></pre></td></tr></table></figure>

<h2 id="2-抽象设计"><a href="#2-抽象设计" class="headerlink" title="2. 抽象设计"></a>2. 抽象设计</h2><p><img src="https://camo.githubusercontent.com/57223dafbceaf008d0fcec518ff40932f504b985/687474703a2f2f692e696d6775722e636f6d2f4b715a336453782e706e67" alt="各个组件"></p>
<h2 id="3-核心组件设计"><a href="#3-核心组件设计" class="headerlink" title="3. 核心组件设计"></a>3. 核心组件设计</h2><p>常见的缓存查询做法，通常使用 redis 或者 memcached 来降低延时。<br>从内存顺序读取1 MB 大约需要 250 微秒，从 SSD 读取数据需要 4 倍时间，而从磁盘读取需要 80 倍时间</p>
<p>因为内存有限，这里使用 LRU 缓存，过滤到常使用的缓存。</p>
<ol>
<li><p>client 端发送一个请求到 web server，通常是一个反向代理服务。</p>
</li>
<li><p>web server 将请求转发到 query api server。</p>
</li>
<li><p>query api server 执行以下操作  </p>
</li>
</ol>
<ul>
<li>解析请求</li>
<li>检查内存里是否有内容匹配此查询<ul>
<li>如果有<ul>
<li>更新缓存到 LRU 头部</li>
<li>返回该值</li>
</ul>
</li>
<li>如果没有<ul>
<li>使用反向索引服务，查询匹配查询的文档<ul>
<li>反向索引服务会对查询结果排序，并返回最前面的结果</li>
</ul>
</li>
<li>使用文档服务返回查询标题和快照内容</li>
<li>更新内存，并将内容放到 LRU 头部</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>缓存实现：使用一个双向链表，新的内容会添加到头部，老的会被移除，同时使用一个 hash table 来快速查找内容。</p>
<p>具体代码可以参考之前面试对象设计之设计一个LruCache.</p>
<h2 id="4-扩展服务设计"><a href="#4-扩展服务设计" class="headerlink" title="4. 扩展服务设计"></a>4. 扩展服务设计</h2><p><img src="https://camo.githubusercontent.com/b6439861687b9a0fc62d0149a364082643ebaf86/687474703a2f2f692e696d6775722e636f6d2f346a39396d68652e706e67"></p>
<p>服务扩展性有很多放面可以做，选取一个基线，做假设，再讨论。</p>
<p>以下一些 topic 几乎每个系统设计都会提到，这里不做扩展，可以自行研究。</p>
<ul>
<li>DNS (域名解析)</li>
<li>Load Balancer (负载均衡)</li>
<li>Horizontal scaling (水平扩展)</li>
<li>Web Server (反向代理)</li>
<li>Api Server (应该服务)</li>
<li>cache (缓存)</li>
<li>Consistency patterns (一致性原则)</li>
<li>Availability patterns (可用性原则)</li>
</ul>
<p>为了应对大量请求负载，以及大量的内存，需要水平扩展机器，有三种主要的方法。</p>
<ul>
<li>每台机器在集群里保存各自的缓存。（简单，但查找会延时）</li>
<li>每台机器在集群里都保存同一份缓存副本。 （简单，但浪费机器内存）</li>
<li>缓存分片，集群里每台机器保存一定hash范围内的缓存。（复杂，理论上最好）</li>
</ul>
<h2 id="5-进一步讨论"><a href="#5-进一步讨论" class="headerlink" title="5. 进一步讨论"></a>5. 进一步讨论</h2><p>取决于问题领域和剩余时间。</p>
<p>SQL (读写分离，分库分表，分片，sql 调优)</p>
<p>NoSql (kv 存储，document 存储，宽表存储，图形数据库)</p>
<p>缓存 (client，cdn，web server，database)</p>
<p>消息队列，微服务，服务发现</p>
<p>其他方面的权衡取舍</p>
<h2 id="6-其他"><a href="#6-其他" class="headerlink" title="6. 其他"></a>6. 其他</h2><p>持续对系统进行基准测试和监控，发现瓶颈，并解决它，服务扩展时一个持续的过程。</p>
</br>

<p>以上</p>
</br>

</br>

<p><strong>声明 ：本站主要是用来整理不懂的知识，大部分内容我都没有完全掌握，请谨慎参考。</strong><br><strong>版权 ：可以转载，但请在文章显著位置注明出处 ！ <a href="https://mjd507.github.io/">https://mjd507.github.io</a></strong></p>
<p><strong>补充 ：为方便面试或者跳槽的小伙伴，我创建了一个公众号「 Daily Problem 」 ，每天推送一道算法题，可以扫以下二维码关注。</strong></p>
<p><img src="https://user-images.githubusercontent.com/8939151/111026177-fb505600-8423-11eb-89e5-687b94b156a0.png"></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/12/29/system-design-3/">设计一个在 AWS 上管理千万级别的用户系统</a><a class="next" href="/2019/12/15/system-design-1/">系统设计开篇</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'fa8d49cc90698365347d',
  clientSecret: 'ad101f458b7f3950fccc09b931977c106cd2c467',
  repo: 'mjd507.github.io',
  owner: 'mjd507',
  admin: ['mjd507'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Back-End/">Back-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Front-End/">Big-Front-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure-Algorithm/">Data Structure & Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Android/">Java & Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Operation-System/">Operation System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Story/">Story</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://johnnyshieh.me/" title="JohnnyShieh" target="_blank">JohnnyShieh</a><ul></ul><a href="https://daimajia.com/" title="代码家" target="_blank">代码家</a><ul></ul><a href="https://imququ.com/" title="Jerry Qu" target="_blank">Jerry Qu</a><ul></ul><a href="https://sivers.org/" title="Derek Sivers" target="_blank">Derek Sivers</a><ul></ul><a href="https://www.alispit.tel/#/" title="alispittel" target="_blank">alispittel</a><ul></ul><a href="http://www.hugogu.cn/" title="Hugo Gu" target="_blank">Hugo Gu</a><ul></ul><a href="https://weekly.75team.com/" title="奇舞周刊" target="_blank">奇舞周刊</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">mjd507.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>