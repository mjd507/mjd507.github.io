<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>关于 double 数据类型 | Jiandong</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-566LR096XR" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-566LR096XR');
</script><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">关于 double 数据类型</h1><a id="logo" href="/.">Jiandong</a><p class="description">Stop stopping</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">关于 double 数据类型</h1><div class="post-meta">2017-03-09<span> | </span><span class="category"><a href="/categories/Big-Back-End/">Big-Back-End</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A1%E5%BC%82%E7%8E%B0%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">诡异现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">计算过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">解决办法</span></a></li></ol></div></div><div class="post-content"><p>最近在做订单部分，在计算下单金额的部分时，遇到了一些很诡异的现象，也花费了一些时间，决定在这里把自己的解决方案记录下来，如果大家有更好的方法，可以留言告诉我。</p>
<span id="more"></span>

<h2 id="诡异现象"><a href="#诡异现象" class="headerlink" title="诡异现象"></a>诡异现象</h2><p>先看下面一段代码，猜猜和你想的一样否。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> value1 = <span class="number">1.2</span> * <span class="number">399</span>;</span><br><span class="line">    System.out.println(value1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> value2 = <span class="number">1.3</span> * <span class="number">399</span>;</span><br><span class="line">    System.out.println(value2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当我看到输出结果时，吓得我立马打开了计算器，重新计算了一下，正确的值应该是 478.8 和 518.7 。看下控制台的输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">478.79999999999995</span></span><br><span class="line"><span class="number">518.7</span></span><br></pre></td></tr></table></figure>

<p>这个结果让我产生了研究的兴趣，在网上收集了一些资料，似乎明白其中的原因：程序执行时，都是二进制数据之间的运算，最后再转化成十进制，所以过程中会产生精度的丢失。我来计算一下这个过程：</p>
<h2 id="计算过程"><a href="#计算过程" class="headerlink" title="计算过程"></a>计算过程</h2><p>将十进制转换为二进制，这里有个<a target="_blank" rel="noopener" href="http://cn.calcuworld.com/%E4%BA%8C%E8%BF%9B%E5%88%B6%E8%AE%A1%E7%AE%97%E5%99%A8">在线二进制计算器</a></p>
<p>1.2 &#x3D; 12 ／ 10  &#x3D;&#x3D;》 1100 ／ 1010</p>
<p>399  &#x3D;&#x3D;》 110001111</p>
<p>为了避免除法的误差，这里先计算乘法再除法即：1100 * 110001111 ／1010</p>
<p><img src="https://user-images.githubusercontent.com/8939151/111024899-0acba100-841c-11eb-9a9e-b4fb68e86009.png" alt="二进制 乘法"></p>
<p><img src="https://user-images.githubusercontent.com/8939151/111024910-1919bd00-841c-11eb-9c94-15ef9a8d2db4.png" alt="二进制 除法"></p>
<p>可以看到，最后的结果是除不尽的，为 1 1 1 0 1 1 1 1 0 .1 1 0 0 1 1 0 0 1 1 0 0 ……</p>
<p>Java 基础不好，特地查了一下，double类型 是 8 个字节，一个字节 8 个 bit，1 个 bit 即一个 二进制数，所以 double 有 64 个二进制位，其中 包括 ：1 个符号位，11 个指数位， 52  个尾数位。符号位表示 double 的正负值，指数位表示 double 的取值范围，尾数位就是 double 的有校位数了。2^52 &#x3D; 4503599627370496，一共16位，所以 double 的精度为 16 位。但是，看下面这句话来自网络：</p>
<blockquote>
<p>浮点数在内存中是按科学计数法来存储的，其整数部分始终是一个隐含着的“1”，由于它是不变的，故不能对精度造成影响。</p>
</blockquote>
<p>所以，由于最左为1的一位省略了，这意味着最多能表示 17 位数，其中绝对能保证的为 16 位，最多表示 17 位。</p>
<p>我把 52 个有效数贴下来：</p>
<p> 1 1 1 0 1 1 1 1 0 .1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 </p>
<p>将上面的二进制转换成十进制：</p>
<p>478 + 1&#x2F;2 + 1&#x2F;2^2 + 1&#x2F;2^5 + 1&#x2F;2^6 + 1&#x2F;2^9 + 1&#x2F;2^10  + 1&#x2F;2^13 + 1&#x2F;2^14 + 1&#x2F;2^17 + 1&#x2F;2^18 + 1&#x2F;2^21+ 1&#x2F;2^22 + 1&#x2F;2^25 + 1&#x2F;2^26 + 1&#x2F;2^29 + 1&#x2F;2^30+ 1&#x2F;2^33 + 1&#x2F;2^34 + 1&#x2F;2^37 + 1&#x2F;2^38 + 1&#x2F;2^41 + 1&#x2F;2^42  &#x3D; <strong>478.799999999999955</strong> 。（计算器算的好累）</p>
<p>根据上面的精度，这里保存前 17 位 ，即 <strong>478.79999999999995</strong>，与 Java 程序算出来的一致。</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>使用 BigDecimal，Java 提供这个类专门用来对超过16位有效位的数进行精确的运算。</p>
<p>上面的 double 乘法运算写法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BigDecimal bd1 = <span class="keyword">new</span> BigDecimal(Double.toString(<span class="number">1.2</span>));</span><br><span class="line">BigDecimal bd2 = <span class="keyword">new</span> BigDecimal(Double.toString(<span class="number">399</span>));</span><br><span class="line"><span class="keyword">double</span> value = bd1.multiply(bd2).doubleValue();</span><br><span class="line">System.out.println(value);</span><br></pre></td></tr></table></figure>

<p>加法，减法，除法与上面类似。另外，项目中，我们很多时候，即使金额是整数或者一位小数，我们也希望显示两位小数，这里可以使用 DecimalFormat 这个类，方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateServiceCharge</span><span class="params">(<span class="keyword">double</span> currentCharge)</span> </span>&#123;</span><br><span class="line">	java.text.DecimalFormat df = <span class="keyword">new</span> java.text.DecimalFormat(<span class="string">&quot;#.00&quot;</span>);</span><br><span class="line">	String charge = df.format(currentCharge);</span><br><span class="line">	tvTotalPrice.setText(<span class="string">&quot;实付款 \n  ￥&quot;</span>+ charge);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>Title: </span>关于 double 数据类型</p><p><span>Author: </span>Jiandong</p><p><span>Date: </span>2017-03-09</p><p><span>Last Update: </span>2025-02-23</p><p><span>Blog Link: </span><a href="/2017/03/09/About-Data-Type-Double/">https://mjd507.github.io/2017/03/09/About-Data-Type-Double/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://mjd507.github.io/2017/03/09/About-Data-Type-Double/"></i></span></p><p><span>Copyright Declaration: </span>Please refer carefully, most of the content I have not fully mastered.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2017/03/15/Make-Gradle-Faster/">提高 Gradle 速度的方法</a><a class="next" href="/2017/02/20/App-Gank/">干货集中营--业余项目</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Back-End/">Big-Back-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Front-End/">Big-Front-End</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://dashaun.com/posts/" title="DaShaun Carter" target="_blank">DaShaun Carter</a><ul></ul><a href="https://develotters.com/" title="develotters" target="_blank">develotters</a><ul></ul><a href="https://vladmihalcea.com/blog/" title="Vlad Mihalcea" target="_blank">Vlad Mihalcea</a><ul></ul><a href="https://www.danvega.dev/blog/" title="Dan Vega" target="_blank">Dan Vega</a><ul></ul><a href="https://toomuchcoding.com/" title="Marcin Grzejszczak" target="_blank">Marcin Grzejszczak</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Jiandong.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>