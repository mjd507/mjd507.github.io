<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Transactional Outbox Pattern | Jiandong</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-566LR096XR" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-566LR096XR');
</script><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Transactional Outbox Pattern</h1><a id="logo" href="/.">Jiandong</a><p class="description">Stop stopping</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Transactional Outbox Pattern</h1><div class="post-meta">2024-07-06<span> | </span><span class="category"><a href="/categories/Big-Back-End/">Big-Back-End</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-number">1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Definition"><span class="toc-number">2.</span> <span class="toc-text">Definition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a></li></ol></div></div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://www.wimdeblauwe.com/blog/2024/06/25/transactional-outbox-pattern-with-spring-boot/">Transactional Outbox pattern with Spring Boot</a></p>
<p><a target="_blank" rel="noopener" href="https://microservices.io/patterns/data/transactional-outbox.html">Pattern: Transactional outbox</a></p>
<span id="more"></span>

<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>suppose in a transaction, we have following actions:<br>db operation 1 – sending message – db operation 2</p>
<p>issues here is:</p>
<ul>
<li>if db operation 2 failed, the transaction data will roll back, but the message is sent.</li>
</ul>
<p>one solution here is:  </p>
<ul>
<li>db operation 1&#x2F;2&#x2F;.. – sending message</li>
</ul>
<p>we put the sending message in the last step, within the transaction.</p>
<p>most of us may do in this way, it’s simple and reliable. only concern is it could be a long transaction as we interacting with exteral system. </p>
<p>do we have other ways?</p>
<ul>
<li>here comes transaction outbox pattern.</li>
</ul>
<h2 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h2><p>The Transactional Outbox is a way to ensure that 2 systems are in sync without having to use a distributed transaction between those systems. </p>
<p>with this pattern, we can first store the fact (send email&#x2F;message…) that should do some external action in database. Then, an asynchronous process can look at the database to know what still needs to happen, and can do that whenever there is time. If the external system is not available, the task can be retried later until it succeeds.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>option 1:  Spring Integration. </p>
<p>put the msg to a jdbc-backed output with a polling handler.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">JdbcChannelMessageStore <span class="title">jdbcChannelMessageStore</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    JdbcChannelMessageStore jdbcChannelMessageStore = <span class="keyword">new</span> JdbcChannelMessageStore(dataSource);</span><br><span class="line">    jdbcChannelMessageStore.setTablePrefix(<span class="string">&quot;_spring_integration_&quot;</span>);</span><br><span class="line">    jdbcChannelMessageStore.setChannelMessageStoreQueryProvider(<span class="keyword">new</span> PostgresChannelMessageStoreQueryProvider());</span><br><span class="line">    <span class="keyword">return</span> jdbcChannelMessageStore;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IntegrationFlow <span class="title">consumerFlow</span><span class="params">(JdbcChannelMessageStore jdbcChannelMessageStore,</span></span></span><br><span class="line"><span class="params"><span class="function">    ConsumerService consumerService)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> IntegrationFlow.from(msgInputDirectChannel())</span><br><span class="line">    .channel(msgOutboxQueueChannel(jdbcChannelMessageStore))</span><br><span class="line">    .handle(message -&gt; &#123;</span><br><span class="line">        consumerService.consume(message.getPayload());</span><br><span class="line">    &#125;, e -&gt; e.poller(Pollers.fixedDelay(Duration.ofSeconds(<span class="number">1</span>)).transactional()))</span><br><span class="line">    .get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>option 2: Spring Modulith</p>
<p>Communication between modules can be done asynchronously by using the ApplicationEventPublisher from Spring core.</p>
<p>Spring Modulith has additional infrastructure to ensure no such event is ever lost by first storing it in the database. We can leverage this to build our outbox pattern.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// first transaction, ensure event are stored in db.</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    User registeredUser = userRepository.save(user);</span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> UserRegisteredEvent(registeredUser.getId()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// second async thread transaction, ensure msg are deliverd to external system.</span></span><br><span class="line"><span class="meta">@ApplicationModuleListener</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onUserRegistered</span><span class="params">(UserRegisteredEvent userRegisteredEvent)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;user registered. id:&#123;&#125;&quot;</span>, userRegisteredEvent.id());</span><br><span class="line">    <span class="comment">// send email/message, etc.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>Title: </span>Transactional Outbox Pattern</p><p><span>Author: </span>mjd507</p><p><span>Date: </span>2024-07-06</p><p><span>Last Update: </span>2025-02-23</p><p><span>Blog Link: </span><a href="/2024/07/06/Transactional-Outbox-Pattern/">https://mjd507.github.io/2024/07/06/Transactional-Outbox-Pattern/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://mjd507.github.io/2024/07/06/Transactional-Outbox-Pattern/"></i></span></p><p><span>Copyright Declaration: </span>This station is mainly used to sort out incomprehensible knowledge. I have not fully mastered most of the content. Please refer carefully.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2024/09/15/multiversion-concurrency-control/">Multiversion concurrency control</a><a class="next" href="/2024/03/17/Jpa-Hibernate-Performance/">Jpa-Hibernate-Performance</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="https://unpkg.com/blueimp-md5/js/md5.js"></script><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: 'fa8d49cc90698365347d',
  clientSecret: 'ad101f458b7f3950fccc09b931977c106cd2c467',
  repo: 'mjd507.github.io',
  owner: 'mjd507',
  admin: ['mjd507'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Back-End/">Big-Back-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Front-End/">Big-Front-End</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://dashaun.com/posts/" title="DaShaun Carter" target="_blank">DaShaun Carter</a><ul></ul><a href="https://vladmihalcea.com/blog/" title="Vlad Mihalcea" target="_blank">Vlad Mihalcea</a><ul></ul><a href="https://www.danvega.dev/blog/" title="Dan Vega" target="_blank">Dan Vega</a><ul></ul><a href="https://imququ.com/" title="Jerry Qu" target="_blank">Jerry Qu</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Jiandong.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>