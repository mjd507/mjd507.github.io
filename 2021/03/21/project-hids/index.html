<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>HIDS | Jiandong</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-566LR096XR" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-566LR096XR');
</script><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HIDS</h1><a id="logo" href="/.">Jiandong</a><p class="description">Stop stopping</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">HIDS</h1><div class="post-meta">2021-03-21<span> | </span><span class="category"><a href="/categories/Big-Back-End/">Big-Back-End</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8B%E5%8F%91"><span class="toc-number">2.</span> <span class="toc-text">配置下发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ETCD-%E7%9B%91%E6%8E%A7"><span class="toc-number">3.</span> <span class="toc-text">ETCD 监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">主机管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B4%A6"><span class="toc-number">5.</span> <span class="toc-text">数据对账</span></a></li></ol></div></div><div class="post-content"><p>HIDS - Host-Based Intrusion Detection System, 主机入侵检测系统。</p>
<span id="more"></span>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>HIDS 是 2019 年公司基于服务器安全考虑，组建了一支队伍，来防御越来越多的外部入侵事件，保障主机安全。</p>
<p>检测主机的 agent 需要满足高性能，资源占用少，同时具备自我熔断（不影响服务器主服务）和恢复功能，在技术栈的选择上，客户端 agent 选取了 go 作为开发语言，服务端选用 Java&#x2F;spring-boot 开发。</p>
<p>为了高可用，agent 和 server 不直接交互，而是借助了分布式协调组件 ETCD 集群，ETCD 也是 go 语言编写，相比 zookeeper 更轻量，k8s 中也把 ETCD 作为存储配置使用。</p>
<h2 id="配置下发"><a href="#配置下发" class="headerlink" title="配置下发"></a>配置下发</h2><p>agent 有一个主进程（master），有 10 个插件进程，每个插件的运行都依赖 master 获取配置，从而可以控制 agent 的行为。</p>
<p>当 agent 注册到 etcd 时，会写入自己的 key：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hids/agent/master/&#123;hostname&#125;</span><br></pre></td></tr></table></figure>

<p>server 会监听到 etcd 注册的 key，同时去 db 获取当前所有插件的配置，组合成一个 json ，写到 etcd：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hids/server/config/&#123;hostname&#125;</span><br></pre></td></tr></table></figure>

<p>下发的内容格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;master&quot;</span>: <span class="number">12345</span>, <span class="comment">// value 为配置的 id，agent 根据此 id，在读一次 etcd，获取具体的 value。</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;file-watcher&quot;</span>: <span class="number">12346</span>,</span><br><span class="line">    <span class="attr">&quot;web-shell&quot;</span>: <span class="number">12347</span>,</span><br><span class="line">    <span class="attr">&quot;proc&quot;</span>: <span class="number">12348</span>,</span><br><span class="line">    <span class="attr">&quot;rasp&quot;</span>: <span class="number">12349</span>,</span><br><span class="line">    <span class="attr">&quot;xxx&quot;</span>: <span class="number">12350</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么下发的时候是下发 id，而不是配置的具体内容呢？</p>
<p>一开始确实是下发内容，但是我们有 50w+ 台主机，等同于向 etcd 写了 50w+ 个相同的 big value，对集群的延迟很大，后面我们还尝试过按每个插件写 value，等于一台主机，写 10 次 value，效果仍然不理想，虽然 value 小了，但是写的次数多了，整体总的 value size 并没有减小。</p>
<p>最终，我们采取了预写的方式，每次下发前，将每个插件的 value 先预写到 etcd 里，db 里保存每个 value 对应 key 的 id，真正下发，按照以上 id 的形式，给到 agent，这个就非常轻量，agent 解析完，在去 etcd 读取 相应的配置。</p>
<p>至此，server 全量主机的配置下发，从一开始的 6 小时到现在的 2min，etcd 的 cpu，mem 和 disk 也都趋于稳定降低的可控状态。</p>
<p>注意：为避免多台主服务处理同一个 agent 注册信息，我们将 6 台主服务也注册到了 etcd，并根据自己 server 的主机名 hash 取模，当监听到 agent 注册时，计算 agent 主机在 server 中的 hash 取模值，只有值相等，才会处理注册信息，确保只有一台主 server 处理注册信息。 主 server 会向 kafka 写一个 message，将 具体的配置下发交给 consumer 处理。</p>
<h2 id="ETCD-监控"><a href="#ETCD-监控" class="headerlink" title="ETCD 监控"></a>ETCD 监控</h2><p>考虑到日益增加的容器数量，以及集群压力，ETCD 集群节点数量由刚开始的 7 台，增加到了 9 台，每个节点 16c + 64g + 500g ssd，平摊下来每个节点连接了不到 6w 的 agent。运行一年多，暂时没有压力。</p>
<p>ETCD 组件本身提供了 metrics 数据输出接口，我们采用了官方推荐的 prometheus 采集数据，并使用 grafana 做聚合和图表展示。</p>
<p>同时接入了内部的告警系统，在 etcd cpu&#x2F;mem&#x2F;disk 超过配置阈值时，触发告警。</p>
<p>在全量配置下发的情况下，cpu 的阈值必触发告警，这也是我们迫切优化配置下发的原因，当然为了避免漏报，我们能容忍一定的告警干扰。</p>
<h2 id="主机管理"><a href="#主机管理" class="headerlink" title="主机管理"></a>主机管理</h2><p>server 端维护了所有注册主机的配置信息，包括每个插件当前的状态，是否熔断下线等。这是基于另一条心跳数据收集链路在实现的。</p>
<p>每台主机每 5 分钟会上报一次心跳数据，心跳日志里就包含了插件的存活状态，当前占用的 cpu&#x2F;mem 等。程序写日志时，指定了心跳日志的 topic，每台主机有个 log-agent，会将日志打到对应的 kafka topic 里面，</p>
<p>server 端有 9 台 kafka consumer，负责消费并入库。同时会调用主机管理团队的接口，获取该主机所处的机房，组织，部门 bu 信息等。</p>
<p>支持按 主机&#x2F;项目组&#x2F;部门&#x2F;产品线&#x2F;机房 等维度下发特定的配置，核心流程和配置下发相同，agent 解析后会跟本身配置 id 做一个 diff ，在觉得要不要获取新配置。</p>
<h2 id="数据对账"><a href="#数据对账" class="headerlink" title="数据对账"></a>数据对账</h2><p>每个插件有自己单独的 kafka topic，在数据收集这一块，我们将 kafka 的数据，接入 elasticsearch，服务端基于 es 数据设计对账功能。部分统计功能接入 storm&#x2F;flink，同时接入 redis 集群，做 top n 的主机统计。</p>
<p>对账有两个维度：一是同比，一是环比，并设置告警模块，告警阈值，告警规则，告警频率，告警聚合等等。</p>
<p>作为链路的最下游，告警曾多次帮助我们第一时间发现上游数据链路的问题。</p>
<p>End.</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>Title: </span>HIDS</p><p><span>Author: </span>Jiandong</p><p><span>Date: </span>2021-03-21</p><p><span>Last Update: </span>2025-08-21</p><p><span>Blog Link: </span><a href="/2021/03/21/project-hids/">https://mjd507.github.io/2021/03/21/project-hids/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://mjd507.github.io/2021/03/21/project-hids/"></i></span></p><p><span>Copyright Declaration: </span>Please refer carefully, most of the content I have not fully mastered.</p></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2022/03/20/Junit5/">Junit 5</a><a class="next" href="/2021/03/09/Linux-Perf-IO/">Linux 性能优化 - IO 篇</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Back-End/">Big-Back-End</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Big-Front-End/">Big-Front-End</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://dashaun.com/posts/" title="DaShaun Carter" target="_blank">DaShaun Carter</a><ul></ul><a href="https://develotters.com/" title="develotters" target="_blank">develotters</a><ul></ul><a href="https://vladmihalcea.com/blog/" title="Vlad Mihalcea" target="_blank">Vlad Mihalcea</a><ul></ul><a href="https://www.danvega.dev/blog/" title="Dan Vega" target="_blank">Dan Vega</a><ul></ul><a href="https://toomuchcoding.com/" title="Marcin Grzejszczak" target="_blank">Marcin Grzejszczak</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2026 <a href="/." rel="nofollow">Jiandong.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>